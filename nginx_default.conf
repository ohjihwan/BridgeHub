server {
    listen 80;
    server_name thebridgehub.org www.thebridgehub.org;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name thebridgehub.org www.thebridgehub.org;

    # SSL (Let's Encrypt)
    ssl_certificate      /etc/letsencrypt/live/thebridgehub.org/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/thebridgehub.org/privkey.pem;
    include              /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam          /etc/letsencrypt/ssl-dhparams.pem;

    # 1) 이메일 인증 게이트웨이 (항상 internal)
    location = /_email_check {
        internal;
        proxy_pass        http://127.0.0.1:7100/api/auth/verify-email-status;
        proxy_set_header  Host $host;
        proxy_set_header  Authorization $http_authorization;
    }

    # 2) 보호된 경로: 이메일 인증 필요
    location /protected/ {
        auth_request       /_email_check;
        auth_request_set   $auth_status $upstream_status;
        error_page 401     = @unauth;
        proxy_pass         http://127.0.0.1:7100$request_uri;
        proxy_set_header   Host $host;
        proxy_set_header   Authorization $http_authorization;
    }
    location @unauth {
        return 302 http://$host/login;
    }

    # 3) 메인 프론트앱 (front-server @7000)
    location / {
        proxy_pass         http://127.0.0.1:7000;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
    }

    # 4) API (Spring Boot @7100)
    location /api/ {
        proxy_pass         http://127.0.0.1:7100;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
    }

    # 5) Socket.io (노드 소켓서버 @7500)
    location /socket.io/ {
        proxy_pass         http://127.0.0.1:7500;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
    }

    # 6) RTC 풀팝업 서버 @7600
    location /rtc/ {
        proxy_pass         http://127.0.0.1:7600;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
    }

    # 7) 관리자 페이지 (front-admin @7700)
    location /admin/ {
    auth_basic           "Admin Area";
    auth_basic_user_file /etc/nginx/.htpasswd;

    proxy_pass         http://127.0.0.1:7700;
    proxy_http_version 1.1;
    proxy_set_header   Host $host;
}

    access_log  /var/log/nginx/bridgehub.access.log;
    error_log   /var/log/nginx/bridgehub.error.log warn;
}
