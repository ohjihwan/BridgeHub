# bridgehub.conf

# HTTP → HTTPS 리다이렉트
server {
    listen 80;
    server_name thebridgehub.org www.thebridgehub.org;
    # HTTP 요청은 모두 HTTPS 로 리다이렉트
    return 301 https://$host$request_uri;
}

# HTTPS 처리
server {
    listen 443 ssl http2;
    server_name thebridgehub.org www.thebridgehub.org;

    # SSL 인증서 경로
    ssl_certificate      /etc/letsencrypt/live/thebridgehub.org/fullchain.pem;
    ssl_certificate_key  /etc/letsencrypt/live/thebridgehub.org/privkey.pem;
    include              /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam          /etc/letsencrypt/ssl-dhparams.pem;

    # --- 이메일 인증 게이트웨이 (/protected/* 경로 보호) ---
    # 내부 검증 요청
    location = /_email_check {
        internal;
        proxy_pass        http://127.0.0.1:7100/api/auth/verify-email-status;
        proxy_set_header  Host $host;
        proxy_set_header  X-Real-IP $remote_addr;
        proxy_set_header  Authorization $http_authorization;
    }

    # 보호할 경로
    location /protected/ {
        auth_request        /_email_check;
        auth_request_set    $auth_status $upstream_status;
        error_page 401      = @unauth;
        proxy_pass          http://127.0.0.1:7100$request_uri;
        proxy_set_header    Host $host;
        proxy_set_header    X-Real-IP $remote_addr;
        proxy_set_header    Authorization $http_authorization;
    }

    location @unauth {
        return 302 https://$host/login;
    }
    # --- 이메일 인증 게이트웨이 끝 ---

    # 정적 파일 (프론트엔드) 배포 폴더
    root /var/www/bridgehub/dist;
    index index.html;

    # 싱글 페이지 앱 라우팅
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 프록시 (Spring Boot)
    location /api/ {
        proxy_pass         http://127.0.0.1:7100;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # Socket.IO 프록시
    location /socket.io/ {
        proxy_pass         http://127.0.0.1:7500;
        proxy_http_version 1.1;
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # 관리자 대시보드 (예: React/Vue 앱)
    location /admin/ {
        proxy_pass         http://127.0.0.1:7700;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # RTC 풀팝업 페이지
    location /rtc/ {
        proxy_pass         http://127.0.0.1:7600;
        proxy_http_version 1.1;
        proxy_set_header   Host $host;
        proxy_set_header   X-Real-IP $remote_addr;
        proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto $scheme;
    }

    # TURN/STUN 서버 healthcheck (선택)
    location /healthz/turn {
        return 200 "OK";
    }

    # 로깅 (선택)
    access_log  /var/log/nginx/bridgehub.access.log;
    error_log   /var/log/nginx/bridgehub.error.log warn;
}
