<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>WebRTC í…ŒìŠ¤íŠ¸</title>
</head>
<body>
  <h2>WebRTC í…ŒìŠ¤íŠ¸ í˜ì´ì§€</h2>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video>
  <br />
  <button onclick="startCall()">ğŸ“ Call</button>
  <button onclick="endCall()">âŒ Hang Up</button>

  <script>
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    let localStream, peerConnection;

    const iceServers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'turn:openrelay.metered.ca:80', username: 'openrelayproject', credential: 'openrelayproject' }
      ]
    };

    async function startCall() {
      localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
      localVideo.srcObject = localStream;

      peerConnection = new RTCPeerConnection(iceServers);

      peerConnection.onicecandidate = async (event) => {
        if (event.candidate) {
          await fetch('/api/rtc/candidate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              userId: 'user123',
              candidate: event.candidate
            })
          });
        }
      };

      peerConnection.ontrack = (event) => {
        remoteVideo.srcObject = event.streams[0];
      };

      localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

      const offer = await peerConnection.createOffer();
      await peerConnection.setLocalDescription(offer);

      const res = await fetch('/api/rtc/offer', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          userId: 'user123',
          offer
        })
      });

      const { answer } = await res.json();
      await peerConnection.setRemoteDescription(answer);
    }

    function endCall() {
      if (peerConnection) {
        peerConnection.close();
        peerConnection = null;
      }
    }
  </script>
</body>
</html>
