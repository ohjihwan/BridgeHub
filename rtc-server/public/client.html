<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>WebRTC Ï±ÑÌåÖÎ∞©</title>
    <style>
      * {
        box-sizing: border-box;
      }
      
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        max-width: 80%;
        margin: 0 auto;
        color: #333333;
      }
      
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        flex-wrap: wrap;
        gap: 16px;
        background: rgba(255, 255, 255, 0.9);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      
      h1 {
        color: #333333;
        font-size: 1.875rem;
        font-weight: 600;
        letter-spacing: -0.025em;
        margin: 0;
        flex: 1;
        text-align: center;
      }
      
      .timer-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 200px;
      }
      
      .timer-icon {
        font-size: 1.2rem;
      }
      
      .timer-text {
        font-weight: 600;
        font-size: 14px;
      }
      
      .timer-warning {
        background: rgba(255, 193, 7, 0.2);
        border-color: rgba(255, 193, 7, 0.3);
        color: #ffc107;
      }
      
      .timer-danger {
        background: rgba(220, 53, 69, 0.2);
        border-color: rgba(220, 53, 69, 0.3);
        color: #dc3545;
        animation: pulse-danger 1s infinite;
      }
      
      @keyframes pulse-danger {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
      }
      
      .controls {
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 32px;
        padding: 24px;
        background: rgba(255, 255, 255, 0.9);
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }
      
      .controls button {
        padding: 12px 20px;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        background: #ffffff;
        color: #333333;
        min-width: 100px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }
      
      .controls button:hover {
        background: #f8f9fa;
        border-color: #667eea;
        transform: translateY(-1px);
      }
      
      .controls button:active {
        background: rgba(255, 255, 255, 0.15);
      }
      
      .video-wrapper {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 16px;
        margin-bottom: 24px;
        max-width: 100%;
      }
      
      .video-container {
        background: #ffffff;
        border-radius: 12px;
        padding: 0;
        text-align: center;
        border: 2px solid #e1e5e9;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .video-container:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
      }
      
      .video-container div, .nickname {
        position: absolute;
        bottom: 12px;
        left: 12px;
        font-weight: 600;
        color: #ffffff;
        font-size: 14px;
        background: rgba(0, 0, 0, 0.7);
        padding: 6px 12px;
        border-radius: 6px;
        z-index: 10;
        margin: 0;
      }
      
      video {
        width: 100%;
        height: 100%;
        min-height: 300px;
        background: #1e2124;
        border-radius: 12px;
        object-fit: cover;
        display: block;
      }
      
      /* Îπà ÏûêÎ¶¨ ÏïÑÏù¥ÏΩò */
      .video-container.empty::before {
        content: "üë§";
        font-size: 4rem;
        opacity: 0.3;
        position: absolute;
        z-index: 5;
        color: #72767d;
      }
      
      .video-container.has-video {
        display: block;
      }
      
      .video-container.has-video::before {
        display: none;
      }
      
      #status-text {
        margin-top: 8px;
        font-size: 0.875rem;
        color: #b9bbbe;
        font-style: italic;
      }
      
      /* ÌôîÎ©¥ Í≥µÏú† Ïãú Î†àÏù¥ÏïÑÏõÉ */
      body.sharing .video-wrapper {
        display: grid;
        grid-template-columns: 1fr 300px;
        grid-template-rows: auto;
        gap: 16px;
        align-items: start;
      }

      body.sharing .video-container.screen-sharing {
        grid-column: 1;
        grid-row: 1 / -1;
        min-height: 600px;
      }

      body.sharing .video-container:not(.screen-sharing) {
        grid-column: 2;
        min-height: 120px;
        margin-bottom: 8px;
      }
      
      /* Ï±ÑÌåÖ Ìå®ÎÑê */
      #chat-panel {
        position: fixed;
        top: 0;
        right: -300px;
        width: 280px;
        height: 100%;
        background: #36393f;
        border-left: 1px solid #40444b;
        box-shadow: -4px 0 6px -1px rgb(0 0 0 / 0.3);
        transition: right 0.3s ease;
        display: flex;
        flex-direction: column;
        z-index: 999;
      }
      
      #chat-panel.open {
        right: 0;
      }
      
      .chat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        background: #2f3136;
        border-bottom: 1px solid #40444b;
        color: #ffffff;
        font-weight: 600;
        font-size: 16px;
      }
      
      .chat-close {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ffffff;
        font-size: 14px;
        cursor: pointer;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
      }
      
      .chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }
      
      #chat-box {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: #36393f;
        font-size: 14px;
        line-height: 1.5;
      }
      
      #chat-box p {
        margin: 8px 0;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #dcddde;
      }
      
      #chat-box::-webkit-scrollbar {
        width: 6px;
      }
      
      #chat-box::-webkit-scrollbar-thumb {
        background: #5865f2;
        border-radius: 3px;
      }
      
      #chat-box::-webkit-scrollbar-track {
        background: transparent;
      }
      
      .chat-input-wrapper {
        display: flex;
        border-top: 1px solid #40444b;
        background: #2f3136;
      }
      
      #chat-input {
        flex: 1;
        padding: 16px;
        border: none;
        background: transparent;
        font-size: 14px;
        outline: none;
        color: #dcddde;
      }
      
      #chat-input::placeholder {
        color: #72767d;
      }
      
      .chat-input-wrapper button {
        padding: 16px 20px;
        border: none;
        background: #5865f2;
        color: white;
        cursor: pointer;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s ease;
      }
      
      .chat-input-wrapper button:hover {
        background: #4752c4;
      }
      
      /* Î∞òÏùëÌòï ÎîîÏûêÏù∏ */
      @media (max-width: 1200px) {
        .video-wrapper {
          grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
        
        body.sharing .video-wrapper {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
        }
        
        body.sharing .video-container#my-container {
          grid-column: 1;
          margin-bottom: 16px;
        }
        
        body.sharing .video-container:not(#my-container) {
          grid-column: 1;
          display: inline-block;
          width: calc(50% - 8px);
          margin: 0 4px 8px 4px;
          vertical-align: top;
        }
      }
      
      @media (max-width: 768px) {
        body {
          padding: 16px;
        }
        
        .header {
          flex-direction: column;
          text-align: center;
        }
        
        h1 {
          font-size: 1.5rem;
          margin-bottom: 16px;
        }
        
        .timer-container {
          order: -1;
          margin-bottom: 16px;
        }
        
        .controls {
          padding: 16px;
          gap: 8px;
        }
        
        .controls button {
          padding: 10px 16px;
          font-size: 13px;
          min-width: 80px;
        }
        
        .video-wrapper {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        
        .video-container {
          min-height: 250px;
        }
        
        video {
          min-height: 250px;
        }
        
        #chat-panel {
          width: 85%;
          right: -85%;
        }
        
        body.sharing .video-container:not(#my-container) {
          width: 100%;
          margin: 0 0 8px 0;
        }
      }
      
      @media (max-width: 480px) {
        .controls {
          flex-direction: column;
          align-items: center;
        }
        
        .controls button {
          width: 100%;
          max-width: 200px;
        }
        
        .video-container {
          min-height: 200px;
        }
        
        video {
          min-height: 200px;
        }
      }
      
      /* Îπà ÏûêÎ¶¨ ÌëúÏãú */
      .video-container:has(.nickname:contains("Îπà ÏûêÎ¶¨")) {
        opacity: 0.6;
        background: #2f3136;
      }
      
      .video-container:has(.nickname:contains("Îπà ÏûêÎ¶¨")) .nickname {
        color: #72767d;
      }

      /* Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ Ïª®ÌÖåÏù¥ÎÑà */
      .mobile-swipe-container {
        display: none;
        position: relative;
        overflow: hidden;
        border-radius: 16px;
        background: #ffffff;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      }

      .swipe-wrapper {
        display: flex;
        transition: transform 0.3s ease;
        width: 100%;
      }

      .swipe-slide {
        min-width: 100%;
        flex-shrink: 0;
      }

      .swipe-indicators {
        display: flex;
        justify-content: center;
        gap: 8px;
        padding: 16px;
        background: rgba(255, 255, 255, 0.9);
      }

      .swipe-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #cccccc;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .swipe-dot.active {
        background: #667eea;
        transform: scale(1.2);
      }

      /* Î™®Î∞îÏùºÏóêÏÑú Ïä§ÏôÄÏù¥ÌîÑ Ïª®ÌÖåÏù¥ÎÑà ÌôúÏÑ±Ìôî */
      @media (max-width: 768px) {
        .video-wrapper {
          display: none;
        }
        
        .mobile-swipe-container {
          display: block;
          margin-bottom: 24px;
        }
        
        .swipe-slide .video-container {
          margin: 16px;
          min-height: 400px;
        }
        
        .swipe-slide video {
          min-height: 400px;
        }
      }

      .video-container.camera-off {
        background: #2f3136;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-size: 1.5rem;
        font-weight: 600;
      }

      .video-container.camera-off video {
        display: none;
      }

      .video-container.camera-off::before {
        content: attr(data-nickname);
        font-size: 2rem;
        color: #ffffff;
        z-index: 10;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <h1 id="title">P2P Ïó∞Í≤∞ Ï§ë...</h1>
      <div class="timer-container" id="timer-container">
        <span class="timer-icon">‚è∞</span>
        <span class="timer-text" id="timer-display">ÌöåÏùò ÏãúÍ∞Ñ: 2ÏãúÍ∞Ñ 00Î∂Ñ 00Ï¥à</span>
      </div>
    </div>
    
    <div class="controls">
      <button id="toggle-camera" onclick="toggleCamera()">üìπ Ïπ¥Î©îÎùº ÏºúÍ∏∞</button>
      <button id="toggle-mic" onclick="toggleMic()">üé§ ÎßàÏù¥ÌÅ¨ ÏºúÍ∏∞</button>
      <button onclick="toggleScreenShare()">üñ•Ô∏è ÌôîÎ©¥ Í≥µÏú†</button>
      <button onclick="toggleChat()">üí¨ Ï±ÑÌåÖ</button>
      <button onclick="leaveRoom()" style="background: #dc3545; border-color: #dc3545;">üö™ ÎÇòÍ∞ÄÍ∏∞</button>
    </div>
    
    <div class="video-wrapper" id="video-wrapper">
      <!-- ÎèôÏ†ÅÏúºÎ°ú Ï∞∏Ïó¨ÏûêÍ∞Ä Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
    </div>

    <!-- Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="mobile-swipe-container" id="mobile-swipe">
      <div class="swipe-wrapper" id="swipe-wrapper">
        <!-- Ïä§ÏôÄÏù¥ÌîÑ Ïä¨ÎùºÏù¥ÎìúÎì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
      </div>
      <div class="swipe-indicators" id="swipe-indicators">
        <!-- Ïù∏ÎîîÏºÄÏù¥ÌÑ∞Îì§Ïù¥ ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
      </div>
    </div>

    <!-- Ï±ÑÌåÖ Ìå®ÎÑê -->
    <div id="chat-panel">
      <div class="chat-header">
        <span>üí¨ Ï±ÑÌåÖ</span>
        <button class="chat-close" onclick="toggleChat()">√ó</button>
      </div>
      <div id="chat-box"></div>
      <div class="chat-input-wrapper">
        <input type="text" id="chat-input" placeholder="Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." />
        <button onclick="sendChat()">Ï†ÑÏÜ°</button>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script>
      const urlParams = new URLSearchParams(location.search);
      const room = urlParams.get("room");
      const nickname = urlParams.get("name");

      // Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ Í∏∞Îä• Î≥ÄÏàòÎì§ÏùÑ Ïä§ÌÅ¨Î¶ΩÌä∏ ÏÉÅÎã®ÏúºÎ°ú Ïù¥Îèô
      let currentSlide = 0;
      let totalSlides = 0;
      let startX = 0;
      let currentX = 0;
      let isDragging = false;

      // ÌÉÄÏù¥Î®∏ Í¥ÄÎ†® Î≥ÄÏàò
      let meetingStartTime;
      let meetingDuration = 2 * 60 * 60 * 1000; // 2ÏãúÍ∞Ñ (Î∞ÄÎ¶¨Ï¥à)
      let timerInterval;

      // Î∞©Î≥Ñ ÌÉÄÏù¥Î®∏ Í¥ÄÎ¶¨ Ìï®ÏàòÎì§ Ï∂îÍ∞Ä
      function getRoomTimerKey() {
        return `webrtc_room_timer_${room}`;
      }

      function initializeTimer() {
        const timerKey = getRoomTimerKey();
        const savedStartTime = localStorage.getItem(timerKey);
        
        if (savedStartTime) {
          // Í∏∞Ï°¥Ïóê Ï†ÄÏû•Îêú ÏãúÏûë ÏãúÍ∞ÑÏù¥ ÏûàÏúºÎ©¥ ÏÇ¨Ïö©
          meetingStartTime = parseInt(savedStartTime);
          console.log("Í∏∞Ï°¥ ÌÉÄÏù¥Î®∏ Î≥µÏõê:", new Date(meetingStartTime));
        } else {
          // ÏÉàÎ°úÏö¥ Î∞©Ïù¥Î©¥ ÌòÑÏû¨ ÏãúÍ∞ÑÏúºÎ°ú ÏãúÏûë
          meetingStartTime = Date.now();
          localStorage.setItem(timerKey, meetingStartTime.toString());
          console.log("ÏÉà ÌÉÄÏù¥Î®∏ ÏãúÏûë:", new Date(meetingStartTime));
        }
      }

      // ÏÑúÎ≤Ñ Í∏∞Î∞ò ÌÉÄÏù¥Î®∏ ÎèôÍ∏∞Ìôî (Í∏∞Ï°¥ localStorage Î∞©ÏãùÍ≥º Î≥ëÌñâ)
      function syncTimerWithServer(serverCreatedAt, serverRemainingTime) {
        if (serverCreatedAt && serverRemainingTime) {
          // ÏÑúÎ≤Ñ ÏãúÍ∞ÑÏù¥ Îçî Ï†ïÌôïÌïòÎØÄÎ°ú ÏÑúÎ≤Ñ Í∏∞Ï§ÄÏúºÎ°ú ÎèôÍ∏∞Ìôî
          meetingStartTime = serverCreatedAt;
          console.log("ÏÑúÎ≤ÑÏôÄ ÌÉÄÏù¥Î®∏ ÎèôÍ∏∞Ìôî:", new Date(meetingStartTime));
          
          // localStorageÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
          const timerKey = getRoomTimerKey();
          localStorage.setItem(timerKey, meetingStartTime.toString());
        }
      }

      function clearRoomTimer() {
        const timerKey = getRoomTimerKey();
        localStorage.removeItem(timerKey);
        console.log("ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨Îê®");
      }

      // Ï∞∏Ïó¨Ïûê Í¥ÄÎ¶¨ Í∞ùÏ≤¥
      const participants = new Map();

      function createVideoContainer(socketId, nickname, isMe = false) {
        const container = document.createElement('div');
        container.className = 'video-container has-video';
        container.id = isMe ? 'my-container' : `container-${socketId}`;
        container.setAttribute('data-nickname', nickname);
        container.setAttribute('data-socket-id', socketId);
        
        const nicknameLabel = document.createElement('div');
        nicknameLabel.className = 'nickname';
        nicknameLabel.textContent = nickname;
        
        const video = document.createElement('video');
        video.className = isMe ? 'myVideo' : 'peerVideo';
        video.setAttribute('playsinline', '');
        video.setAttribute('autoplay', '');
        if (isMe) video.setAttribute('muted', '');
        
        container.appendChild(nicknameLabel);
        container.appendChild(video);
        
        return container;
      }

      function addParticipant(socketId, nickname, isMe = false) {
        if (participants.has(socketId)) return;
        
        const container = createVideoContainer(socketId, nickname, isMe);
        document.getElementById('video-wrapper').appendChild(container);
        
        participants.set(socketId, {
          nickname,
          container,
          isMe,
          cameraOn: true,
          isScreenSharing: false
        });
        
        console.log(`Ï∞∏Ïó¨Ïûê Ï∂îÍ∞Ä: ${nickname} (${socketId})`);
        updateMobileSwipe();
      }

      function removeParticipant(socketId) {
        const participant = participants.get(socketId);
        if (participant) {
          participant.container.remove();
          participants.delete(socketId);
          console.log(`Ï∞∏Ïó¨Ïûê Ï†úÍ±∞: ${participant.nickname}`);
          updateMobileSwipe();
        }
      }

      function updateParticipantCamera(socketId, cameraOn) {
        const participant = participants.get(socketId);
        if (participant) {
          participant.cameraOn = cameraOn;
          if (cameraOn) {
            participant.container.classList.remove('camera-off');
          } else {
            participant.container.classList.add('camera-off');
          }
        }
      }

      function setScreenSharing(socketId, isSharing) {
        // Î™®Îì† Ï∞∏Ïó¨ÏûêÏùò ÌôîÎ©¥ Í≥µÏú† ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
        participants.forEach((participant, id) => {
          participant.isScreenSharing = false;
          participant.container.classList.remove('screen-sharing');
        });
        
        if (isSharing && participants.has(socketId)) {
          const participant = participants.get(socketId);
          participant.isScreenSharing = true;
          participant.container.classList.add('screen-sharing');
          document.body.classList.add('sharing');
        } else {
          document.body.classList.remove('sharing');
        }
      }

      // Í∏∞Ï°¥ Ìï®ÏàòÎì§ÏùÑ ÏÉàÎ°úÏö¥ ÎèôÏ†Å ÏãúÏä§ÌÖúÏúºÎ°ú ÍµêÏ≤¥
      function assignPeerNickname(nickname) {
        // Ïù¥ Ìï®ÏàòÎäî Ïù¥Ï†ú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå - addParticipantÎ°ú ÎåÄÏ≤¥
      }

      function removePeerNickname(nickname) {
        // Ïù¥ Ìï®ÏàòÎäî Ïù¥Ï†ú ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÏùå - removeParticipantÎ°ú ÎåÄÏ≤¥
      }

      function formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        return `${hours}ÏãúÍ∞Ñ ${minutes.toString().padStart(2, '0')}Î∂Ñ ${seconds.toString().padStart(2, '0')}Ï¥à`;
      }

      function updateTimer() {
        const currentTime = Date.now();
        const elapsedTime = currentTime - meetingStartTime;
        const remainingTime = meetingDuration - elapsedTime;
        
        const timerDisplay = document.getElementById('timer-display');
        const timerContainer = document.getElementById('timer-container');
        
        if (remainingTime <= 0) {
          // ÏãúÍ∞Ñ Ï¢ÖÎ£å
          timerDisplay.textContent = 'ÌöåÏùò ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§';
          timerContainer.classList.add('timer-danger');
          clearInterval(timerInterval);
          
          // ÌÉÄÏù¥Î®∏ Ï†ïÎ¶¨
          clearRoomTimer();
          
          // 3Ï¥à ÌõÑ ÏûêÎèôÏúºÎ°ú Î∞© ÎÇòÍ∞ÄÍ∏∞
          setTimeout(() => {
            alert('ÌöåÏùò ÏãúÍ∞ÑÏù¥ Ï¢ÖÎ£åÎêòÏñ¥ Î∞©ÏóêÏÑú ÎÇòÍ∞ëÎãàÎã§.');
            leaveRoom();
          }, 3000);
          
          return;
        }
        
        timerDisplay.textContent = `ÌöåÏùò ÏãúÍ∞Ñ: ${formatTime(remainingTime)}`;
        
        // 30Î∂Ñ Ïù¥ÌïòÏùº Îïå Í≤ΩÍ≥† ÏÉâÏÉÅ
        if (remainingTime <= 30 * 60 * 1000) {
          timerContainer.classList.add('timer-warning');
        }
        
        // 5Î∂Ñ Ïù¥ÌïòÏùº Îïå ÏúÑÌóò ÏÉâÏÉÅ
        if (remainingTime <= 5 * 60 * 1000) {
          timerContainer.classList.remove('timer-warning');
          timerContainer.classList.add('timer-danger');
        }
      }

      function startTimer() {
        updateTimer(); // Ï¶âÏãú Ìïú Î≤à Ïã§Ìñâ
        timerInterval = setInterval(updateTimer, 1000); // 1Ï¥àÎßàÎã§ ÏóÖÎç∞Ïù¥Ìä∏
      }

      if (!room || !nickname) {
        alert("ÏûòÎ™ªÎêú Ï†ëÍ∑ºÏûÖÎãàÎã§.");
        location.href = "/";
      }

      document.getElementById("title").innerText = `Î∞©: ${room} | ÎãâÎÑ§ÏûÑ: ${nickname}`;

      // Ïù¥ Ï§ÑÏùÑ Ï†úÍ±∞ÌïòÍ±∞ÎÇò Ï£ºÏÑù Ï≤òÎ¶¨
      // const myFace = document.querySelector('#my-container video') || document.createElement('video');

      // ÎåÄÏã† ÎèôÏ†ÅÏúºÎ°ú Ï∞æÎäî Ìï®Ïàò Ï∂îÍ∞Ä
      function getMyVideo() {
        return document.querySelector('#my-container video');
      }

      const peerVideos = document.querySelectorAll(".peerVideo");
      const chatBox = document.getElementById("chat-box");
      const chatInput = document.getElementById("chat-input");

      let myStream;
      let myPeerConnection;
      let isScreenSharing = false;
      let screenTrack = null;

      const socket = io();

      socket.emit("join", { roomId: room, nickname });

      socket.on("room-full", () => {
        alert("ÏûÖÏû• Ïù∏Ïõê Ï¥àÍ≥º");
        location.href = "/";
      });

      // Î∞© Ï†ïÎ≥¥ ÏàòÏã† (ÌÉÄÏù¥Î®∏ ÎèôÍ∏∞ÌôîÏö©)
      socket.on("room-info", (roomInfo) => {
        console.log("Î∞© Ï†ïÎ≥¥ ÏàòÏã†:", roomInfo);
        
        // ÏÑúÎ≤Ñ Í∏∞Î∞ò ÌÉÄÏù¥Î®∏ ÎèôÍ∏∞Ìôî
        syncTimerWithServer(roomInfo.createdAt, roomInfo.remainingTime);
        
        // Ï∞∏Ïó¨Ïûê Ï†ïÎ≥¥ ÌëúÏãú (ÏÑ†ÌÉùÏ†Å)
        if (roomInfo.participants) {
          console.log("ÌòÑÏû¨ Ï∞∏Ïó¨Ïûê:", roomInfo.participants);
        }
      });

      // Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ ÏàòÏã†
      socket.on("chat-history", (chatHistory) => {
        console.log("Ï±ÑÌåÖ ÌûàÏä§ÌÜ†Î¶¨ ÏàòÏã†:", chatHistory.length + "Í∞ú");
        
        // Í∏∞Ï°¥ Ï±ÑÌåÖÏóê ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä
        chatHistory.forEach(chat => {
          appendChat(chat.from, chat.message, chat.timestamp);
        });
        
        // Íµ¨Î∂ÑÏÑ† Ï∂îÍ∞Ä
        if (chatHistory.length > 0) {
          const separator = document.createElement("div");
          separator.style.cssText = `
            text-align: center;
            color: #888;
            font-size: 12px;
            margin: 10px 0;
            border-top: 1px solid #444;
            padding-top: 10px;
          `;
          separator.textContent = "--- Ïù¥Ï†Ñ ÎåÄÌôî ---";
          chatBox.appendChild(separator);
        }
      });

      // ÏÇ¨Ïö©Ïûê ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ ÏàòÏã†
      socket.on("user-status-update", (data) => {
        console.log("ÏÇ¨Ïö©Ïûê ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏:", data);
        // ÌïÑÏöîÏãú UIÏóê ÏÉÅÌÉú ÌëúÏãú (Ïòà: ÎßàÏù¥ÌÅ¨/Ïπ¥Î©îÎùº ÏïÑÏù¥ÏΩò)
      });

      // ÌôîÎ©¥ Í≥µÏú† ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
      socket.on("screen-share-update", (data) => {
        console.log("ÌôîÎ©¥ Í≥µÏú† ÏÉÅÌÉú:", data);
        // ÌôîÎ©¥ Í≥µÏú† Ï§ëÏù∏ ÏÇ¨Ïö©Ïûê ÌëúÏãú
      });

      socket.on("user-joined", (data) => {
        const { nickname: joinedNickname, socketId } = data;
        addParticipant(socketId || 'unknown', joinedNickname);
        appendChat("ÏãúÏä§ÌÖú", `${joinedNickname}ÎãòÏù¥ ÏûÖÏû•ÌñàÏäµÎãàÎã§.`);
      });

      socket.on("user-left", (data) => {
        const { nickname: leftNickname, socketId } = data;
        removeParticipant(socketId || leftNickname);
        appendChat("ÏãúÏä§ÌÖú", `${leftNickname}ÎãòÏù¥ Î∞©ÏùÑ ÎÇòÍ∞îÏäµÎãàÎã§.`);
      });

      socket.on("rtc-message", async (message) => {
        const content = JSON.parse(message);
        if (content.event === "offer") {
          await initConnection();
          await myPeerConnection.setRemoteDescription(content.data);
          myStream.getTracks().forEach(track => myPeerConnection.addTrack(track, myStream));
          const answer = await myPeerConnection.createAnswer();
          await myPeerConnection.setLocalDescription(answer);
          sendSignal("answer", answer);
        } else if (content.event === "answer") {
          await myPeerConnection.setRemoteDescription(content.data);
        } else if (content.event === "candidate") {
          if (content.data) await myPeerConnection.addIceCandidate(content.data);
        }
      });

      socket.on("chat-message", (data) => {
        const { from, message, timestamp } = JSON.parse(data);
        appendChat(from, message, timestamp);
      });

      socket.on("peer-left", () => {
        appendChat("ÏãúÏä§ÌÖú", "ÏÉÅÎåÄÎ∞©Ïù¥ Î∞©ÏùÑ ÎÇòÍ∞îÏäµÎãàÎã§.");
      });

      chatInput.addEventListener("keyup", (e) => {
        if (e.key === "Enter") sendChat();
      });

      async function getMedia() {
  try {
    console.log("Ïπ¥Î©îÎùº Ï†ëÍ∑º ÏãúÎèÑ Ï§ë...");
    
    // Îã®Í≥ÑÎ≥ÑÎ°ú ÏãúÎèÑ
    let constraints = { video: true, audio: true };
    
    try {
      myStream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (e) {
      console.log("Ï≤´ Î≤àÏß∏ ÏãúÎèÑ Ïã§Ìå®, ÎπÑÎîîÏò§Îßå ÏãúÎèÑ:", e);
      myStream = await navigator.mediaDevices.getUserMedia({ video: true });
    }
    
    // ÎèôÏ†ÅÏúºÎ°ú ÎÇ¥ ÎπÑÎîîÏò§ ÏöîÏÜå Ï∞æÍ∏∞
    const myVideo = document.querySelector('#my-container video');
    if (myVideo) {
      myVideo.srcObject = myStream;
      await myVideo.play();
      console.log("Ïπ¥Î©îÎùº Ïó∞Í≤∞ ÏÑ±Í≥µ");
      
      // Ïπ¥Î©îÎùº Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÏûêÎèôÏúºÎ°ú ÏºúÏßÑ ÏÉÅÌÉú)
      const cameraButton = document.getElementById("toggle-camera");
      if (cameraButton) {
        cameraButton.innerText = "üìπ Ïπ¥Î©îÎùº ÎÅÑÍ∏∞";
      }
      
      // ÎπÑÎîîÏò§Í∞Ä Ïû¨ÏÉùÎêòÎ©¥ Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
      myVideo.onplaying = () => {
        console.log("ÎπÑÎîîÏò§ Ïû¨ÏÉù ÏãúÏûëÎê®");
        setTimeout(() => {
          if (window.innerWidth <= 768) {
            updateMobileSwipe();
          }
        }, 500);
      };
    } else {
      console.error("ÎÇ¥ ÎπÑÎîîÏò§ Ïª®ÌÖåÏù¥ÎÑàÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§");
    }
    
  } catch (e) {
    console.error("Media Error:", e);
    alert("Ïπ¥Î©îÎùº Ï†ëÍ∑º Ïã§Ìå®: " + e.message + "\nÎ∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú Ïπ¥Î©îÎùº Í∂åÌïúÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
  }
}

      async function initConnection() {
        myPeerConnection = new RTCPeerConnection({
          iceServers: [{ url: "stun:stun.l.google.com:19302" }],
        });

        myPeerConnection.onicecandidate = (event) => {
          if (event.candidate) sendSignal("candidate", event.candidate);
        };

        myPeerConnection.addEventListener("addstream", (e) => {
          const peerVideo = Array.from(peerVideos).find(v => !v.srcObject);
          if (peerVideo) {
            peerVideo.srcObject = e.stream;
            // Ïä§Ìä∏Î¶ºÏù¥ Ï∂îÍ∞ÄÎê† Îïå Ïª®ÌÖåÏù¥ÎÑà ÌÅ¥ÎûòÏä§ Î≥ÄÍ≤Ω
            const container = peerVideo.closest('.video-container');
            const nicknameLabel = container.querySelector('.nickname');
            if (nicknameLabel && nicknameLabel.textContent === "Îπà ÏûêÎ¶¨") {
              nicknameLabel.textContent = "Ï∞∏Ïó¨Ïûê";
            }
            container.classList.remove('empty');
            container.classList.add('has-video');
          }
        });
      }

      async function createOffer() {
        await initConnection();
        if (!myStream) return;
        myStream.getTracks().forEach(track => myPeerConnection.addTrack(track, myStream));
        const offer = await myPeerConnection.createOffer();
        await myPeerConnection.setLocalDescription(offer);
        sendSignal("offer", offer);
      }

      async function startConnection() {
  try {
    console.log("Ïó∞Í≤∞ ÏãúÏûë...");
    
    // ÎÇ¥ Ï∞∏Ïó¨Ïûê Ï∂îÍ∞Ä
    const mySocketId = socket.id || 'me';
    addParticipant(mySocketId, nickname, true);
    
    // Ïû†Ïãú Í∏∞Îã§Î¶∞ ÌõÑ ÎØ∏ÎîîÏñ¥ ÏãúÏûë (DOMÏù¥ ÏÉùÏÑ±Îê† ÏãúÍ∞Ñ ÌôïÎ≥¥)
    setTimeout(async () => {
      await getMedia();
      await createOffer();
    }, 100);
    
    initializeTimer();
    startTimer();
    
    setTimeout(() => {
      if (window.innerWidth <= 768) {
        initMobileSwipe();
      }
    }, 2000);
    
  } catch (error) {
    console.error("Ïó∞Í≤∞ ÏãúÏûë Ïò§Î•ò:", error);
  }
}

      function sendSignal(event, data) {
        socket.emit("rtc-message", JSON.stringify({ roomId: room, event, data }));
      }

      function sendChat() {
        const msg = chatInput.value.trim();
        if (!msg) return;
        const now = Date.now();
        socket.emit("chat-message", JSON.stringify({ roomId: room, from: nickname, message: msg, timestamp: now }));
        appendChat(nickname, msg, now);
        chatInput.value = "";
      }

      function appendChat(who, msg, time = null) {
        const p = document.createElement("p");
        const now = time ? new Date(time) : new Date();
        const hhmm = now.toLocaleTimeString("ko-KR", { hour: "2-digit", minute: "2-digit", hour12: false });
        p.textContent = `[${hhmm}] ${who}: ${msg}`;
        chatBox.appendChild(p);
        chatBox.scrollTop = chatBox.scrollHeight;
      }

      function toggleCamera() {
        if (!myStream) return;
        
        const videoTrack = myStream.getVideoTracks()[0];
        if (!videoTrack) return;
        
        videoTrack.enabled = !videoTrack.enabled;
        
        const button = document.getElementById("toggle-camera");
        button.innerText = videoTrack.enabled ? "üìπ Ïπ¥Î©îÎùº ÎÅÑÍ∏∞" : "üìπ Ïπ¥Î©îÎùº ÏºúÍ∏∞";
        
        // ÎÇ¥ Ïπ¥Î©îÎùº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
        const mySocketId = socket.id || 'me';
        updateParticipantCamera(mySocketId, videoTrack.enabled);
        
        // DOM ÏóÖÎç∞Ïù¥Ìä∏
        const myVideo = getMyVideo();
        if (myVideo) {
          if (videoTrack.enabled) {
            myVideo.style.display = 'block';
          } else {
            myVideo.style.display = 'none';
          }
        }
        
        // ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Ï†ÑÏÜ°
        socket.emit("user-status", {
          roomId: room,
          status: {
            camera: videoTrack.enabled,
            mic: myStream.getAudioTracks()[0]?.enabled || false
          }
        });
        
        // Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
        setTimeout(updateMobileSwipe, 100);
      }

      function toggleMic() {
        if (!myStream) return;
        const audioTrack = myStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        document.getElementById("toggle-mic").innerText = audioTrack.enabled ? "ÏùåÏÜåÍ±∞" : "ÎßàÏù¥ÌÅ¨ ÏºúÍ∏∞";
        
        // ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Ï†ÑÏÜ°
        socket.emit("user-status", {
          roomId: room,
          status: {
            camera: myStream.getVideoTracks()[0]?.enabled || false,
            mic: audioTrack.enabled
          }
        });
      }

      function leaveRoom() {
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        if (myPeerConnection) {
          myPeerConnection.close();
          myPeerConnection = null;
        }
        socket.disconnect();
        
        // ÌÉÄÏù¥Î®∏Îäî Ï†ïÎ¶¨ÌïòÏßÄ ÏïäÏùå (Îã§Î•∏ ÏÇ¨ÎûåÏù¥ ÏïÑÏßÅ ÏûàÏùÑ Ïàò ÏûàÏùå)
        // clearRoomTimer(); // Ïù¥ Ï§ÑÏùÄ Ï£ºÏÑù Ï≤òÎ¶¨
        
        location.href = "/";
      }

      async function toggleScreenShare() {
  const mySocketId = socket.id || 'me';
  const myVideo = document.querySelector('#my-container video');
  
  if (!myVideo) {
    console.error("ÎÇ¥ ÎπÑÎîîÏò§ ÏöîÏÜåÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§");
    return;
  }
  
  if (!isScreenSharing) {
    try {
      console.log("ÌôîÎ©¥ Í≥µÏú† ÏãúÏûë...");
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      screenTrack = stream.getVideoTracks()[0];
      
      // WebRTC Ïó∞Í≤∞Ïù¥ ÏûàÏúºÎ©¥ Ìä∏Îûô ÍµêÏ≤¥
      if (myPeerConnection) {
        const sender = myPeerConnection.getSenders().find(s => s.track && s.track.kind === "video");
        if (sender) {
          await sender.replaceTrack(screenTrack);
          console.log("WebRTC Ìä∏Îûô ÍµêÏ≤¥ ÏôÑÎ£å");
        }
      }
      
      // DOMÏóê ÌôîÎ©¥ Í≥µÏú† Ïä§Ìä∏Î¶º Î∞òÏòÅ
      const screenStream = new MediaStream([screenTrack]);
      myVideo.srcObject = screenStream;
      await myVideo.play();
      
      console.log("ÌôîÎ©¥ Í≥µÏú† DOM Î∞òÏòÅ ÏôÑÎ£å");
      
      // ÌôîÎ©¥ Í≥µÏú† Ï¢ÖÎ£å Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
      screenTrack.onended = () => {
        console.log("ÌôîÎ©¥ Í≥µÏú†Í∞Ä Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§");
        stopScreenShare();
      };
      
      isScreenSharing = true;
      setScreenSharing(mySocketId, true);
      
      // ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Ï†ÑÏÜ°
      socket.emit("screen-share-status", {
        roomId: room,
        isSharing: true
      });
      
      // Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
      setTimeout(updateMobileSwipe, 200);
      
    } catch (e) {
      console.error("ÌôîÎ©¥ Í≥µÏú† Ïò§Î•ò:", e);
      alert("ÌôîÎ©¥ Í≥µÏú† Ïã§Ìå®: " + e.message);
    }
  } else {
    stopScreenShare();
  }
}

function stopScreenShare() {
  if (!isScreenSharing) return;
  
  console.log("ÌôîÎ©¥ Í≥µÏú† Ï§ëÏßÄ...");
  const myVideo = document.querySelector('#my-container video');
  
  if (myPeerConnection && myStream) {
    // WebRTC Ìä∏ÎûôÏùÑ ÏõêÎûò Ïπ¥Î©îÎùºÎ°ú Î≥µÏõê
    const sender = myPeerConnection.getSenders().find(s => s.track && s.track.kind === "video");
    if (sender && myStream.getVideoTracks()[0]) {
      sender.replaceTrack(myStream.getVideoTracks()[0]);
      console.log("WebRTC Ìä∏Îûô Î≥µÏõê ÏôÑÎ£å");
    }
  }
  
  // DOMÏóê ÏõêÎûò Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º Î≥µÏõê
  if (myVideo && myStream) {
    myVideo.srcObject = myStream;
    myVideo.play();
    console.log("Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶º DOM Î≥µÏõê ÏôÑÎ£å");
  }
  
  // ÌôîÎ©¥ Í≥µÏú† Ìä∏Îûô Ï†ïÎ¶¨
  if (screenTrack) {
    screenTrack.stop();
    screenTrack = null;
  }
  
  isScreenSharing = false;
  const mySocketId = socket.id || 'me';
  setScreenSharing(mySocketId, false);
  
  // ÏÑúÎ≤ÑÏóê ÏÉÅÌÉú Ï†ÑÏÜ°
  socket.emit("screen-share-status", {
    roomId: room,
    isSharing: false
  });
  
  // Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
  setTimeout(updateMobileSwipe, 200);
}

      function toggleChat() {
        document.getElementById("chat-panel").classList.toggle("open");
      }

      // ‚úÖ Ïó∞Í≤∞ ÏãúÏûë
      startConnection();

      // Î™®Î∞îÏùº Ïä§ÏôÄÏù¥ÌîÑ Í∏∞Îä•
      

      // Î≥ëÎ†¨ Ï≤òÎ¶¨ Î∞©ÏßÄÏö© ÌÅê
const assignQueue = [];
let isAssigning = false;

function processAssignQueue() {
  if (isAssigning || assignQueue.length === 0) return;
  
  isAssigning = true;
  const nickname = assignQueue.shift();
  const labels = document.querySelectorAll(".nickname");
  
  for (const label of labels) {
    if (label.textContent === "Îπà ÏûêÎ¶¨") {
      label.textContent = nickname;
      const container = label.closest('.video-container');
      container.classList.remove('empty');
      container.classList.add('has-video');
      
      setTimeout(() => {
        updateMobileSwipe();
        isAssigning = false;
        processAssignQueue();
      }, 100);
      return;
    }
  }
  
  // Îπà ÏûêÎ¶¨Í∞Ä ÏóÜÏúºÎ©¥ Ïû¨ÏãúÎèÑ
  assignQueue.push(nickname);
  setTimeout(() => {
    isAssigning = false;
    processAssignQueue();
  }, 500);
}

// assignPeerNickname Ìï®ÏàòÎ•º ÌÅê Í∏∞Î∞òÏúºÎ°ú Î≥ÄÍ≤Ω
function assignPeerNickname(nickname) {
  assignQueue.push(nickname);
  processAssignQueue();
}

// Ïä¨ÎùºÏù¥Îìú index Ï¶ùÍ∞ÄÌòï ÏÉùÏÑ±
function initMobileSwipe() {
  const swipeWrapper = document.getElementById('swipe-wrapper');
  const indicators = document.getElementById('swipe-indicators');
  
  if (!swipeWrapper || !indicators) return;
  
  swipeWrapper.innerHTML = '';
  indicators.innerHTML = '';
  
  const allContainers = [
    document.getElementById('my-container'),
    ...Array.from(document.querySelectorAll('.video-container:not(#my-container)'))
  ].filter(container => container && container.classList.contains('has-video'));
  
  totalSlides = allContainers.length;
  if (totalSlides === 0) {
    console.log("Ïä§ÏôÄÏù¥ÌîÑÌï† Ïä¨ÎùºÏù¥ÎìúÍ∞Ä ÏóÜÏäµÎãàÎã§");
    return;
  }
  
  allContainers.forEach((container, index) => {
    const slide = document.createElement('div');
    slide.className = 'swipe-slide';
    
    const clonedContainer = container.cloneNode(true);
    const originalVideo = container.querySelector('video');
    const clonedVideo = clonedContainer.querySelector('video');
    
    if (originalVideo && clonedVideo) {
      clonedVideo.srcObject = originalVideo.srcObject;
    }
    
    slide.appendChild(clonedContainer);
    swipeWrapper.appendChild(slide);
    
    const dot = document.createElement('div');
    dot.className = `swipe-dot ${index === 0 ? 'active' : ''}`;
    dot.addEventListener('click', () => goToSlide(index));
    indicators.appendChild(dot);
  });
  
  currentSlide = 0;
  goToSlide(0);
  
  const container = document.getElementById('mobile-swipe');
  
  container.removeEventListener('touchstart', handleTouchStart);
  container.removeEventListener('touchmove', handleTouchMove);
  container.removeEventListener('touchend', handleTouchEnd);
  container.removeEventListener('mousedown', handleMouseStart);
  container.removeEventListener('mousemove', handleMouseMove);
  container.removeEventListener('mouseup', handleMouseEnd);
  container.removeEventListener('mouseleave', handleMouseEnd);
  
  container.addEventListener('touchstart', handleTouchStart, { passive: false });
  container.addEventListener('touchmove', handleTouchMove, { passive: false });
  container.addEventListener('touchend', handleTouchEnd, { passive: false });
  container.addEventListener('mousedown', handleMouseStart);
  container.addEventListener('mousemove', handleMouseMove);
  container.addEventListener('mouseup', handleMouseEnd);
  container.addEventListener('mouseleave', handleMouseEnd);
  
  console.log(`Ïä§ÏôÄÏù¥ÌîÑ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å: ${totalSlides}Í∞ú Ïä¨ÎùºÏù¥Îìú`);
}

      function handleTouchStart(e) {
        startX = e.touches[0].clientX;
        isDragging = true;
      }

      function handleTouchMove(e) {
        if (!isDragging) return;
        e.preventDefault(); // Ïä§ÌÅ¨Î°§ Î∞©ÏßÄ
        
        currentX = e.touches[0].clientX;
        const diffX = currentX - startX;
        const wrapper = document.getElementById('swipe-wrapper');
        
        if (wrapper) {
          const translateX = -currentSlide * 100 + (diffX / window.innerWidth) * 100;
          wrapper.style.transform = `translateX(${translateX}%)`;
        }
      }

      function handleTouchEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        
        const diffX = currentX - startX;
        const threshold = window.innerWidth * 0.2; // 20% Ïù¥ÏÉÅ Ïä§ÏôÄÏù¥ÌîÑÌï¥Ïïº ÎÑòÏñ¥Í∞ê
        
        if (Math.abs(diffX) > threshold) {
          if (diffX > 0 && currentSlide > 0) {
            currentSlide--;
          } else if (diffX < 0 && currentSlide < totalSlides - 1) {
            currentSlide++;
          }
        }
        
        goToSlide(currentSlide);
      }

      function handleMouseStart(e) {
        startX = e.clientX;
        isDragging = true;
        e.preventDefault();
      }

      function handleMouseMove(e) {
        if (!isDragging) return;
        currentX = e.clientX;
        const diffX = currentX - startX;
        const wrapper = document.getElementById('swipe-wrapper');
        wrapper.style.transform = `translateX(${-currentSlide * 100 + (diffX / window.innerWidth) * 100}%)`;
      }

      function handleMouseEnd(e) {
        if (!isDragging) return;
        isDragging = false;
        
        const diffX = currentX - startX;
        const threshold = window.innerWidth * 0.2;
        
        if (Math.abs(diffX) > threshold) {
          if (diffX > 0 && currentSlide > 0) {
            currentSlide--;
          } else if (diffX < 0 && currentSlide < totalSlides - 1) {
            currentSlide++;
          }
        }
        
        goToSlide(currentSlide);
      }

      function goToSlide(index) {
        currentSlide = Math.max(0, Math.min(index, totalSlides - 1));
        const wrapper = document.getElementById('swipe-wrapper');
        wrapper.style.transform = `translateX(-${currentSlide * 100}%)`;
        
        // Ïù∏ÎîîÏºÄÏù¥ÌÑ∞ ÏóÖÎç∞Ïù¥Ìä∏
        const dots = document.querySelectorAll('.swipe-dot');
        dots.forEach((dot, i) => {
          dot.classList.toggle('active', i === currentSlide);
        });
      }

      // Ï∞∏Ïó¨ÏûêÍ∞Ä Î≥ÄÍ≤ΩÎê† ÎïåÎßàÎã§ Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
      function updateMobileSwipe() {
        if (window.innerWidth <= 768) {
          initMobileSwipe();
        }
      }

      // Í∏∞Ï°¥ assignPeerNickname Ìï®Ïàò ÏàòÏ†ïÌïòÏó¨ Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏ Ï∂îÍ∞Ä
      const originalAssignPeerNickname = assignPeerNickname;
      assignPeerNickname = function(nickname) {
        originalAssignPeerNickname(nickname);
        setTimeout(updateMobileSwipe, 100);
      };

      const originalRemovePeerNickname = removePeerNickname;
      removePeerNickname = function(nickname) {
        originalRemovePeerNickname(nickname);
        setTimeout(updateMobileSwipe, 100);
      };

      // ÏúàÎèÑÏö∞ Î¶¨ÏÇ¨Ïù¥Ï¶à Ïãú Ïä§ÏôÄÏù¥ÌîÑ ÏóÖÎç∞Ïù¥Ìä∏
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          if (window.innerWidth <= 768) {
            initMobileSwipe();
          }
        }, 300);
      });

      // Ï¥àÍ∏∞ Î°úÎìú Ïãú Ïä§ÏôÄÏù¥ÌîÑ Ï¥àÍ∏∞Ìôî (Ïó¨Îü¨ Î≤à ÏãúÎèÑ)
      setTimeout(() => {
        if (window.innerWidth <= 768) {
          console.log("Ï≤´ Î≤àÏß∏ Ïä§ÏôÄÏù¥ÌîÑ Ï¥àÍ∏∞Ìôî ÏãúÎèÑ");
          initMobileSwipe();
        }
      }, 1000);

      setTimeout(() => {
        if (window.innerWidth <= 768) {
          console.log("Îëê Î≤àÏß∏ Ïä§ÏôÄÏù¥ÌîÑ Ï¥àÍ∏∞Ìôî ÏãúÎèÑ");
          initMobileSwipe();
        }
      }, 2000);

      setTimeout(() => {
        if (window.innerWidth <= 768) {
          console.log("ÏÑ∏ Î≤àÏß∏ Ïä§ÏôÄÏù¥ÌîÑ Ï¥àÍ∏∞Ìôî ÏãúÎèÑ");
          initMobileSwipe();
        }
      }, 3000);

// ÏÉàÎ°úÏö¥ ÏóêÎü¨ Ï≤òÎ¶¨ Ïù¥Î≤§Ìä∏Îì§
socket.on("room-expired", () => {
  alert("Î∞© ÏãúÍ∞ÑÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.");
  leaveRoom();
});

socket.on("join-error", (error) => {
  alert("ÏûÖÏû• Ïò§Î•ò: " + error);
  location.href = "/";
});

socket.on("room-force-closed", (data) => {
  alert("Î∞©Ïù¥ Í∞ïÏ†úÎ°ú Ï¢ÖÎ£åÎêòÏóàÏäµÎãàÎã§: " + (data.reason || "Í¥ÄÎ¶¨ÏûêÏóê ÏùòÌï¥"));
  leaveRoom();
});

// Ïó∞Í≤∞ ÏÉÅÌÉú Ï≤¥ÌÅ¨ (Ìïë-ÌêÅ)
setInterval(() => {
  socket.emit("ping");
}, 30000); // 30Ï¥àÎßàÎã§

socket.on("pong", () => {
  console.log("ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ï†ïÏÉÅ");
});
    </script>
  </body>
</html>
